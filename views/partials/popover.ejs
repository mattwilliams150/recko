<div id="popover-tag" class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="md-poptitle sm-poptitle text-primary" id="exampleModalLabel">To give you more relevant recommendations so you can stay ahead of the curve on new places we need to know a little more about you. </h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="popform-tag" class="form-validate">
                <div class="modal-body">

                        <div id="popoverpage1">
                            <div class="mb-2"><h5>Earn £10 off your next meal when you register!</h5></div>
                            <div class="mb-3">Our clever bots work tirelessly behind the scenes to find you fantastic recommendations for bars, restaurants, and activities based on your interests. To do this, they need to know what you like! Please select between 3 and 5 tags below.”</div>
                            <div class="form-group tag-pill-button">
                                <div class="tag-food">
                                    <h4>Food & Drink</h4>
                                    <% for (tagId in categories.tagObj) { %>
                                        <% if (categories.tagObj[tagId].type == "foodAndDrink") {%>
                                            <% var tagReadable = categories.tagObj[tagId].name %>
                                            <% var tagImage = categories.tagObj[tagId].image %>
                                                <label for="<%=tagId%>_pop">
                                                    <input type="checkbox" class="tagcheckbox tagscheck" id="<%=tagId%>_pop" name="<%=tagId%>_pop" >
                                                    <div class="badge badge-pill tag-pill-food tag-pill-button sm-tag-pill-large md-tag-pill-large">
                                                        <img class="pr-2 sm-tag-pill-large-img md-tag-pill-large-img" src="img/icons/<%= tagImage %>" alt="<%=tagReadable%> Icon">
                                                        <%=tagReadable%>
                                                    </div>
                                                </label>
                                        <% } %>
                                    <% } %>
                                </div>
                                <div class="tag-experience">
                                    <h4>Experience</h4>
                                    <% for (tagId in categories.tagObj) { %>
                                        <% if (categories.tagObj[tagId].type == "experience") {%>
                                            <% var tagReadable = categories.tagObj[tagId].name %>
                                            <% var tagImage = categories.tagObj[tagId].image %>
                                                <label for="<%=tagId%>_pop">
                                                    <input type="checkbox" class="tagcheckbox tagscheck" id="<%=tagId%>_pop" name="<%=tagId%>_pop" >
                                                    <div class="badge badge-pill tag-pill-experience tag-pill-button sm-tag-pill-large md-tag-pill-large">
                                                        <img class="pr-2 sm-tag-pill-large-img md-tag-pill-large-img" src="img/icons/<%= tagImage %>" alt="<%=tagReadable%> Icon">
                                                        <%=tagReadable%>
                                                    </div>
                                                </label>
                                        <% } %>
                                    <% } %>
                                </div>
                                <div class="tag-greatfor">
                                    <h4>Great for...</h4>
                                    <% for (tagId in categories.tagObj) { %>
                                        <% if (categories.tagObj[tagId].type == "greatFor") {%>
                                            <% var tagReadable = categories.tagObj[tagId].name %>
                                            <% var tagImage = categories.tagObj[tagId].image %>
                                                <label for="<%=tagId%>_pop">
                                                    <input type="checkbox" class="tagcheckbox tagscheck" id="<%=tagId%>_pop" name="<%=tagId%>_pop" >
                                                    <div class="badge badge-pill tag-pill-greatfor tag-pill-button sm-tag-pill-large md-tag-pill-large">
                                                        <img class="pr-2 sm-tag-pill-large-img md-tag-pill-large-img" src="img/icons/<%= tagImage %>" alt="<%=tagReadable%> Icon">
                                                        <%=tagReadable%>
                                                    </div>
                                                </label>
                                        <% } %>
                                    <% } %>
                                </div>
                            </div>
                        </div>

                        <div id="popoverpage2" style="display: none">

                            <div class="form-group mx-4">
                                <label class="form-label" for="popEmail">Email Address</label>
                                <input class="form-control" name="popEmail" id="popEmail" type="email" placeholder="name@address.com" autocomplete="off" required data-msg="Please enter your email">
                                <span id="email_alert" class="text-danger" style="display: none"></span>
                            </div>
                            <div class="form-group mx-4">
                                <label class="form-label" for="popPassword">Password</label>
                                <input class="form-control" name="popPassword" id="popPassword" placeholder="Password" type="password" required data-msg="Please enter your password">
                                <span id="pw_alert" class="text-danger" style="display: none"></span>
                            </div>
                            <div class="form-group mx-4">
                                <label class="form-label" for="popConfirmPassword">Confirm Password</label>
                                <input class="form-control" name="popConfirmPassword" id="popConfirmPassword" placeholder="Password" type="password" required data-msg="Confirm your password">
                                <span id="conpw_alert" class="text-danger" style="display: none"></span>
                            </div>
                            <div class="form-group mx-4">
                                <label class="form-label mb-0" for="username">Display Name</label>
                                <p class="text-sm text-muted"><small>(DISPLAYED ON YOUR REVIEWS SO DON'T USE YOUR EMAIL ADDRESS)</small></p>
                                <input class="form-control" name="username" id="username" type="text" placeholder="jbloggs1976" autocomplete="nickname" required data-msg="Please enter your display name">
                                <span id="popusername_alert" class="text-danger" style="display: none"></span>
                            </div>
                        </div>

                </div>
                </form>

                <div class="modal-footer">
                    <span>Already have an account?</span>
                    <button class="btn btn-link"><a href="/login">Login</a></button>
                    <div id="tagpopalert" class="alert alert-danger" style="display: none"></div>
                    <button id="popnext1" class="btn btn-primary" onclick="popnext(1)">Next</button>
                    <% //<button id="popoverlater" type="button" class="btn btn-secondary" onclick="popsubmit('later')">Maybe Later</button> %>
                    <button id="popoversubmit" class="btn btn-primary" onclick="popsubmit()" style="display: none">Submit</button>
                </div>

        </div>
    </div>
</div>

<div id="popover-type" class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title text-primary" id="exampleModalLabel">To give you more relevant recommendations so you can stay ahead of the curve on new places we need to know a little more about you. </h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="popform-type" class="form-validate">
                <div class="modal-body">

                        <div id="popoverpage1" style="display: none">
                            <div class="mb-3"><h5>Which cuisines do you like when it comes to restaurants?</h5></div>
                            <div class="form-group tag-pill-button">
                                <% for (i=0; i<categories.cuisines.length; i++) { %>
                                <% var cuisines = categories.cuisines[i] %>
                                    <label for="<%=cuisines%>_pop">
                                        <input type="checkbox" class="tagcheckbox" id="<%=cuisines%>_pop" name="<%=cuisines%>_pop" ><div class="mr-1 badge badge-pill tag-pill px-3 py-2 mb-2 tag-pill-button"><%=cuisines%></div>
                                    </label>
                                <% } %>
                            </div>

                            <div class="mb-3"><h5>What do you go for when it comes to bars?</h5></div>
                            <div class="form-group tag-pill-button">
                                <% for (i=0; i<categories.bars.length; i++) { %>
                                <% var bars = categories.bars[i] %>
                                    <label for="<%=bars%>_pop">
                                        <input type="checkbox" class="tagcheckbox" id="<%=bars%>_pop" name="<%=bars%>_pop" ><div class="mr-1 badge badge-pill tag-pill px-3 py-2 mb-2 tag-pill-button"><%=bars%></div>
                                    </label>
                                <% } %>
                            </div>

                            <div class="mb-3"><h5>What sort of activities do you like?</h5></div>
                            <div class="form-group tag-pill-button">
                                <% for (i=0; i<categories.thingsToDo.length; i++) { %>
                                <% var thingsToDo = categories.thingsToDo[i] %>
                                    <label for="<%=thingsToDo%>_pop">
                                        <input type="checkbox" class="tagcheckbox" id="<%=thingsToDo%>_pop" name="<%=thingsToDo%>_pop" ><div class="mr-1 badge badge-pill tag-pill px-3 py-2 mb-2 tag-pill-button"><%=thingsToDo%></div>
                                    </label>
                                <% } %>
                            </div>
                    </div>
                </div>
                </form>

                <div class="modal-footer">
                    
                    <button id="popnext1" class="btn btn-primary" onclick="popnext(1)">Next</button>
                    <button id="popnext2" class="btn btn-primary" onclick="popnext(2)" style="display: none">Next</button>
                    <% //<button id="popoverlater" type="button" class="btn btn-secondary" onclick="popsubmit('later')">Maybe Later</button> %>
                    <button id="popoversubmit" class="btn btn-primary" onclick="popsubmit()" style="display: none">Submit</button>
                </div>

        </div>
    </div>
</div>



<script>
    
    var checklimit = 5;
    var checkmin = 3;

    var excludePopupUrls = 
        [
            "/login",
            "/register",
            "/account"
        ];
    
    var pref = localStorage.getItem('preferences');
    var popuptimer = Number(localStorage.getItem('popuptimer'))
    var popdelay = 1000 * 60 * 60 * 24 // shown once per day
    console.log(popuptimer);
    console.log(popuptimer + popdelay)
    console.log(Date.now())
    if (pref != 1 && <%=loggedIn%> == false && !excludePopupUrls.includes(window.location.pathname) && (popuptimer + popdelay) < Date.now()) {
        $('#popover-tag').modal('show');
        localStorage.setItem('popuptimer', Date.now());
    }

    function popnext() {
        
            if($('.tagscheck:checked').length < checkmin) {
                $("#tagpopalert").text('Please select at least 3 tags').show();
            } else {
                $("#tagpopalert").hide();
                
                $("#popoverpage1").hide();
                $("#popoverpage2").show();

                $("#popnext1").hide();
                $("#popoversubmit").show();
            }

    };

    function popsubmit(action) {
        if (document.getElementById('popEmail').value.length !== 0 && document.getElementById('popEmail').value.includes("@")) {
            $("#email_alert").hide();
            var email = 1
        } else {
            $("#email_alert").text('*please enter a valid email').show();
            var email = 0
        }
        if (document.getElementById('popPassword').value.length == 0) {
            $("#pw_alert").text('*please enter a password').show();
            var pw = 0
        } else {
            $("#pw_alert").hide();
            var pw = 1
        }
        if (document.getElementById('popPassword').value !==  document.getElementById('popConfirmPassword').value) {
            $("#conpw_alert").text('*passwords do not match').show();
            var cpw = 0
        } else {
            $("#conpw_alert").hide();
            var cpw = 1
        }
        if (document.getElementById('username').value.length == 0) {
            $("#popusername_alert").text('*please enter a display name').show();
            var pu = 0
        } else {
            $("#popusername_alert").hide();
            var pu = 1
        }

        if (email == 1 && pw == 1 && cpw == 1 && pu == 1) {
            $.ajax({
                url: "/popover",
                type: "POST",
                data: $('#popform-tag').serialize(),
                success: function(data){
                    if(data.loggedIn == false) {
                        $("#email_alert").html(data.errors[0]).show();
                    } else {
                        $('#popover-tag').modal('hide')
                        localStorage.setItem('preferences', 1);
                    }
                    //console.log(data);
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    console.log("Status: " + textStatus);
                    console.log("Error: " + errorThrown);
                }
            })
        }
    };
    

$('input.tagscheck').on('change', function(evt) { 
    if($('.tagscheck:checked').length > checklimit) {
        this.checked = false;
    }
});

</script>
